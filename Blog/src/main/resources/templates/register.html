<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Реєстрація</title>

    <script>
        (function() {
            try {
                var theme = localStorage.getItem('theme');
                if (theme === 'light') {
                    // Додаємо клас до <html>
                    document.documentElement.classList.add('light-theme');
                }
            } catch (e) {
                console.error("Помилка застосування теми з localStorage", e);
            }
        })();
    </script>
    <link rel="stylesheet" th:href="@{/css/styles.css}">

    <script th:src="@{/js/theme-switcher.js}" defer></script>

</head>
<body>
<div class="register-container">
    <a th:href="@{/}" class="back-link">&larr; На головну</a>
    <h1>Вітаємо</h1>
    <hr />

    <h2 class="text-center">Реєстрація</h2>
    <form action="#" id="register-form"
          th:action="@{/register}"
          th:object="${account}"
          method="POST"
          novalidate> <div class="form-group" id="nickname-group">
        <label for="firstname">Ваш псевдонім
            <span class="tooltip-container">
                    <span class="tooltip-icon" aria-label="Інформація">ⓘ</span>
                    <span class="tooltip-text">Мінімум 4, максимум 20 символів, без пробілів. Буде видно всім користувачам.</span>
                 </span>
        </label>
        <input id="firstname" type="text" th:field="*{firstName}" placeholder="Псевдонім" required
               pattern="^\S*$"          minlength="4"             maxlength="20"            title="Мінімум 4, максимум 20 символів, без пробілів." /> <span class="error-message" id="nickname-error"></span>
    </div>

        <div class="form-group" id="lastname-group">
            <label for="lastname">Ваше Ім'я
                <span class="tooltip-container">
                    <span class="tooltip-icon" aria-label="Інформація">ⓘ</span>
                     <span class="tooltip-text">Максимум 20 символів. Дозволено літери, цифри, дефіс, апостроф (без пробілів). Буде видно тільки адміністратору.</span>
                 </span>
            </label>
            <input id="lastname" type="text" th:field="*{lastName}" placeholder="Ім'я" required
                   pattern="^[a-zA-Zа-яА-ЯёЁіїєґҐ'0-9-]+$" maxlength="20" title="Максимум 20 символів. Дозволено літери, цифри, дефіс, апостроф." />
            <span class="error-message" id="lastname-error"></span>
        </div>

        <div class="form-group">
            <label for="email">Пошта</label>
            <input id="email" type="email" th:field="*{email}" placeholder="Пошта" required
                   pattern="^\S+$" title="Введіть дійсну адресу пошти (без пробілів)." />
            <span class="error-message" id="email-error"></span>
        </div>

        <div class="form-group" id="password-group">
            <label for="password">Пароль</label>
            <input id="password" type="password" th:field="*{password}" placeholder="Пароль" required
                   pattern="^\S*$"    minlength="8"     title="Мінімум 8 символів, без пробілів." />
            <span class="error-message" id="password-error"></span>
        </div>

        <button type="submit">Зареєструватися</button>
        <p class="terms">Натискаючи "Зареєструватися", ви погоджуєтесь з умовами використання.</p>
    </form>
</div>

<script>
    // --- Код для підказок (можна винести в окремий файл, якщо використовується на інших сторінках) ---
    document.addEventListener('DOMContentLoaded', () => {
        // Додайте тут логіку ініціалізації підказок, якщо вона потрібна
        // Наприклад, обробники hover/focus для .tooltip-container
    });
    // Функція закриття підказок (якщо потрібна)
    function closeAllTooltips(exceptContainer = null) {
        // Ваша логіка закриття
    }

    // --- JavaScript для валідації форми ---
    const form = document.getElementById('register-form');
    const nicknameInput = document.getElementById('firstname');
    const lastnameInput = document.getElementById('lastname');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');

    // Знаходимо батьківські групи для анімації
    const nicknameGroup = document.getElementById('nickname-group');
    const lastnameGroup = document.getElementById('lastname-group');
    const passwordGroup = document.getElementById('password-group');

    // Знаходимо елементи для виводу помилок
    const nicknameError = document.getElementById('nickname-error');
    const lastnameError = document.getElementById('lastname-error');
    const emailError = document.getElementById('email-error');
    const passwordError = document.getElementById('password-error');

    const submitButton = form.querySelector('button[type="submit"]');

    // Константи для валідації
    const namePattern = /^[a-zA-Zа-яА-ЯёЁіїєґҐ'0-9-]+$/; // Для поля "Ім'я"
    const minNicknameLength = 4;
    const maxNicknameLength = 20;
    const maxLastnameLength = 20;
    const minPasswordLength = 8;

    // Функція для перевірки одного поля та показу/приховування помилки
    function validateField(inputElement, errorElement) {
        let errorMessage = '';
        let isValid = true;
        const value = inputElement.value.trim(); // Без зовнішніх пробілів
        const originalValue = inputElement.value; // З пробілами для перевірки
        let shakeElement = null; // Елемент для анімації (батьківський div)

        // 1. Перевірка на пустоту (якщо поле required)
        if (inputElement.required && value === '') {
            errorMessage = "Це поле є обов'язковим.";
            isValid = false;
            // Не встановлюємо shakeElement тут
        } else {
            // 2. Специфічні перевірки для кожного поля (якщо не порожнє)
            switch (inputElement.id) {
                case 'firstname': // Псевдонім
                    shakeElement = nicknameGroup;
                    if (/\s/.test(originalValue)) { // Перевірка на будь-які пробіли
                        errorMessage = 'Псевдонім не повинен містити пробілів.';
                        isValid = false;
                    } else if (value.length > 0 && value.length < minNicknameLength) { // Мін. довжина
                        errorMessage = `Мінімальна довжина: ${minNicknameLength} символи.`;
                        isValid = false;
                    } else if (value.length > maxNicknameLength) { // Макс. довжина
                        errorMessage = `Максимальна довжина: ${maxNicknameLength} символів.`;
                        isValid = false;
                    }
                    break;

                case 'lastname': // Ім'я
                    shakeElement = lastnameGroup;
                    if (/\s/.test(originalValue)) { // Перевірка на будь-які пробіли
                        errorMessage = 'Ім\'я не повинно містити пробілів.';
                        isValid = false;
                    } else if (!namePattern.test(value) && value.length > 0) { // Перевірка патерну
                        errorMessage = 'Дозволено літери, цифри, дефіс, апостроф.';
                        isValid = false;
                    } else if (value.length > maxLastnameLength) { // Макс. довжина
                        errorMessage = `Максимальна довжина: ${maxLastnameLength} символів.`;
                        isValid = false;
                    }
                    break;

                case 'email': // Пошта
                    // Немає shakeElement для email
                    if (/\s/.test(originalValue)) { // Перевірка на пробіли
                        errorMessage = 'Пошта не повинна містити пробілів.';
                        isValid = false;
                        // Використовуємо вбудовану валідацію браузера для формату email
                    } else if (!inputElement.checkValidity() && value.length > 0) {
                        errorMessage = 'Будь ласка, введіть дійсну адресу пошти.';
                        isValid = false;
                    }
                    break;

                case 'password': // Пароль
                    shakeElement = passwordGroup;
                    if (/\s/.test(originalValue)) { // Перевірка на пробіли
                        errorMessage = 'Пароль не повинен містити пробілів.';
                        isValid = false;
                    } else if (value.length > 0 && value.length < minPasswordLength) { // Мін. довжина
                        errorMessage = `Пароль має містити щонайменше ${minPasswordLength} символів.`;
                        isValid = false;
                    }
                    break;
            }
        }

        // Показ/приховування помилки та стилів
        errorElement.textContent = errorMessage.trim();
        if (!isValid) {
            errorElement.style.display = 'block';
            inputElement.classList.add('invalid-input');
            // Запуск анімації, якщо це помилка формату/довжини (не "обов'язкове поле")
            // і якщо елемент для анімації знайдено
            if (errorMessage !== "Це поле є обов'язковим." && shakeElement && !shakeElement.classList.contains('shake')) {
                shakeElement.classList.add('shake');
                // Видаляємо клас анімації після її завершення
                setTimeout(() => { shakeElement.classList.remove('shake'); }, 400); // 400ms - тривалість анімації
            }
        } else {
            // Якщо поле валідне, приховуємо помилку і знімаємо стиль помилки
            errorElement.style.display = 'none';
            inputElement.classList.remove('invalid-input');
        }
        return isValid; // Повертаємо результат валідації
    }

    // Додаємо слухачів події 'input' для миттєвої валідації
    [nicknameInput, lastnameInput, emailInput, passwordInput].forEach(input => {
        const errorElement = document.getElementById(input.id + '-error');
        if (errorElement) {
            input.addEventListener('input', () => validateField(input, errorElement));
        }
    });

    // Додаємо слухача події 'submit' для фінальної перевірки перед відправкою
    form.addEventListener('submit', function(event) {
        // Примусово валідуємо всі поля
        const isNicknameValid = validateField(nicknameInput, nicknameError);
        const isLastnameValid = validateField(lastnameInput, lastnameError);
        const isEmailValid = validateField(emailInput, emailError);
        const isPasswordValid = validateField(passwordInput, passwordError);

        // Якщо хоча б одне поле не валідне, зупиняємо відправку форми
        if (!isNicknameValid || !isLastnameValid || !isEmailValid || !isPasswordValid) {
            event.preventDefault(); // Зупиняємо стандартну дію браузера (відправку)
            console.log("Form submission prevented due to validation errors.");

            // Фокусуємося на першому невалідному полі для зручності
            if (!isNicknameValid) nicknameInput.focus();
            else if (!isLastnameValid) lastnameInput.focus();
            else if (!isEmailValid) emailInput.focus();
            else if (!isPasswordValid) passwordInput.focus();
        }
        // Якщо всі поля валідні, форма відправиться
    });
    // --- Кінець JS валідації ---
</script>

</body>
</html>